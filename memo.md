## IAM 계정이 Cost and usage에 접근이 불가능한 문제
- 증상
  - IAM 계정에 AWSBillingReadOnlyAccess와 Billing 권한을 부여했음에도 Cost and usage에 접근이 불가능하다고 한다.
- 해결 방법
  - 루트 계정에 AWS 콘솔 접속
  - 우상단의 계정 클릭 후 Account로 이동
  - 이동한 계정 설정 페이지에서 IAM user and role access to Billing information 찾기
  - Edit 버튼을 눌러 IAM user/role access to billing information 활설화
  - IAM 계정이 Cost and usage에 접근 가능한지 확인
- 참고
  - [IAM 사용자 AWS 결제 대시보드 접근 설정 방법](https://byounghee.tistory.com/315)

## 웹 페이지 배포하기
- 과정: AWS Amplify + Git을 활용하여 진행
  - 우선 AWS CLI와 사용할 IAM 계정의 액세스 키가 요구됨
  - [AWS CLI 설치](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
  - IAM 계정의 액세스 키 생성하기
    - AWS 콘솔의 우상단의 계정을 클릭하여 [보안 자격 증명] 메뉴로 이동
    - 보안 자격 증명 설정 페이지에서 스크롤하여 [액세스 키] 항목으로 이동
    - 새로운 액세스 키를 만들어 보안상으로 안전한 곳에 csv로 저장하거나 메모해둘 것
  - 터미널에서 `aws configure` 커맨드 실행 후, 액세스 키와 비밀 액세스 키와 리전을 입력
  - `aws s3 cp s3://wildrydes-us-east-1/WebApplication/1_StaticWebHosting/website ./ --recursive` 커맨드 실행
  - 만들어놓은 GitHub 레포지토리에 해당 코드 push
  - AWS Amplify를 GitHub 레포지토리와 연계하여 웹에 배포하기
    - Amplify 콘솔에서 새로운 앱 만들기 (이 떄 [웹 앱 호스팅]으로 만들어줘야 함)
    - [기존 코드에서] 항목 중 [GitHub] 선택
    - (GitHub 계정에 연결되어 있지 않은 경우) 권한을 부여함으로써 연결
    - 만들어놓은 GitHub 레포지토리 -> 메인 브랜치 선택
    - (모노레포인 경우) 모노레포에 체크한 뒤 해당하는 디렉토리 입력
    - [AWS Amplify가 프로젝트 루트 디렉터리에 호스팅된 모든 파일을 자동으로 배포하도록 허용] 체크
    - 다음으로 넘어가 [저장 및 배포]
  - AWS Amplify에서 확인된 배포 링크에 잘 들어가지는지 확인
- 참고
  - [AWS - 서버리스 웹 애플리케이션 구축 - 모듈 1: 지속적인 배포를 통한 정적 웹 호스팅](https://aws.amazon.com/ko/getting-started/hands-on/build-serverless-web-app-lambda-apigateway-s3-dynamodb-cognito/module-1/)
  - [AWS - Install or update the latest version of the AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
  - [AWS - Managing access keys for IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html#Using_CreateAccessKey)

## 사용자 풀 만들기
- Amazon SES 설정 필요
  - Amazon SES 콘솔 -> 구성 -> 확인된 자격 증명 -> 자격 증명 생성
  - 자격 증명 세부 정보에서 [보안 인증 유형]을 [이메일 주소]로 선택
  - 이메일 주소 입력 후, 전송된 확인 메일의 링크로 인증 절차 완료하기
- Amazon Cognito 콘솔에서 [사용자 풀 생성]
  - [로그인 환경 구성]의 [Cognito 사용자 풀 로그인 옵션] 섹션에서 [사용자 이름]을 선택 후 다음으로 넘어가기
  - [보안 요구 사항 구성]에서 [암호 정책 모드]를 [Cognito 기본값]으로 유지 후 [MFA 없음]을 선택하고 다음으로 넘어가기
  - [가입 환경 구성]은 건들지 않고 다음으로 넘어가기
  - [메시지 전송 구성]에서 [이메일 공급자]가 [Amazon SES를 사용하여 이메일 전송 - 권장됨]으로 되어있는지 확인 후, [발신 이메일 주소]에서 Amazon SES에서 설정한 이메일 선택하고 다음으로 넘어가기
  - [앱 통합]에서 사용자 풀 이름 짓기
  - [초기 앱 클라이언트]에서 앱 클라이언트 이름 짓기
  - [검토 및 생성]에서 사용자 풀 생성 완료하기
- 상단의 과정에서 배포했던 웹 페이지의 [/js/config.js] 파일 편집하기
  - Amazon Cognito 콘솔로 들어가 이전 과정에서 진행했던 사용자 풀 확인
  - userPoolID: [사용자 풀 개요]의 사용자 풀 ID
  - userPoolClientID: [앱 통합] > [앱 클라이언트 및 분석]에 있는 앱 클라이언트 ID
  - region: [사용자 풀 개요]에서 [풀 ARN] 값 참고
  - invokeUrl은 일단 비워둔다
  - 파일 저장 후 커밋 푸시
- 구현이 되었는지 확인
  - AWS Amplify에 배포됐던 페이지에서 가입 진행 후 로그인 여부 확인
- 참고
  - [AWS - 서버리스 웹 애플리케이션 구축 - 모듈 2: 사용자 관리](https://aws.amazon.com/ko/getting-started/hands-on/build-serverless-web-app-lambda-apigateway-s3-dynamodb-cognito/module-2/)
  - [Amazon SES에서 자격 증명 생성 및 확인 - 이메일 주소 자격 증명 생성](https://docs.aws.amazon.com/ko_kr/ses/latest/dg/creating-identities.html#verify-email-addresses-procedure)

## 서버리스 백엔드 환경 구성
- Amazon DynamoDB 테이블 생성하기
  - Amazon DynamoDB 콘솔에서 테이블 생성
    - 테이블 이름, 파티션 키 입력
    - 테이블 생성 버튼 클릭
  - 테이블이 생성될 때까지 대기 (약간의 시간이 소요됨)
  - 테이블이 생성된 뒤, 해당 테이블로 들어가 [개요] > [일반 정보] > [추가 정보]로 들어가 [ARN] 복사해두기
- Lambda 함수를 위한 IAM 역할 생성
  - 해당 Lambda 함수는 [CloudWatch Logs에 로그를 쓸 수 있는 권한]과 [DynamoDB 테이블에 항목을 쓸 수 있는 권한]이 필요함
  - IAM 콘솔에서 [역할] 항목으로 들어가 [역할 생성]
    - [신뢰할 수 있는 엔티티 유형]에서 [AWS 서비스] 선택 후, [사용 사례]에서 [Lambda] 선택하여 다음으로 넘어가기
    - 선택할 수 있는 권한 중 [AWSLambdaBasicExecutionRole]을 선택하여 체크 후 다음으로 넘어가기
    - 역할 이름을 지은 후 [역할 생성]
  - IAM 콘솔에서 [역할]에서 방금 생성한 역할에 권한 추가
    - 해당 역할을 선택한 후, [권한 추가]에서 [인라인 정책 생성]
    - [서비스 선택]에서 [DynamoDB] 선택
    - [작업 허용됨] 펼치기 (자습서는 "[작업 선택]을 선택합니다"라고 나와있으나, 실제론 [작업 허용됨]을 가리킴)
    - [작업 허용됨]에서 제공되는 권한 중 [PutItem]의 체크박스에 체크
    - [리소스]에서 [특정] 선택 후 [ARN 추가] 창을 열고 [텍스트] 탭으로 들어가, 이전 단계에서 복사했던 테이블의 ARN 붙여넣기
    - 정책 이름을 짓고 [정책 생성] 버튼 누르기
- 요청 처리용 Lambda 함수 생성
  - AWS Lambda 콘솔에서 함수 생성하기
    - 콘솔 우상단의 [함수 생성] 클릭
    - [새로 작성] 선택 (자습서에는 [처음부터 새로 작성]이라고 나왔지만, 실제론 [새로 작성]이라고 나옴)
    - 함수 이름, 런타임 등등 설정
    - [기본 실행 역할 변경] 드롭다운에서 [기존 역할 사용] 선택
    - 이전 과정에서 생성했던 역할 선택
    - [함수 생성] 버튼 클릭
  - 생성한 함수의 [코드 섹션]에서 코드 작성 후 [Deploy] 클릭 (자습서에는 [배포]라고 나왔지만, 실제론 [Deploy]라고 나옴)
- 구현이 되었는지 확인
  - 이전 과정에서 생성한 함수 선택 후 [코드 섹션]에서 [Test] 드롭다운 클릭 후 [Configure test event]로 진입
  - [새 이벤트 생성] 선택 후 이벤트 필드 이름과 이벤트 JSON 작성
  - [저장] 버튼으로 저장하기
  - 다시 [코드 섹션]에서 [Test] 드롭다운 클릭 후, 해당 이벤트 선택
  - [Test]를 클릭하여 테스트
  - 결과가 의도한 대로 나왔는지 확인
- 참고
  - [AWS - 서버리스 웹 애플리케이션 구축 - 모듈 3: 서버리스 서비스 백엔드](https://aws.amazon.com/ko/getting-started/hands-on/build-serverless-web-app-lambda-apigateway-s3-dynamodb-cognito/module-3/)
